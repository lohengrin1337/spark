<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="style/style.css">
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Doto:wght@100..900&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Zilla+Slab+Highlight:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <button id="theme-toggle">Dark/Light</button>

        <h1 class="title">
            spark<span class="title-blink">_</span>
            <a href="https://docs.google.com/document/d/1My-jYaf-8mOTmdXAtjj3_PuOP_TXhAPCn7qatrkTl2A/edit?usp=sharing">
                <img class="title-spark" src="img/scooter-nobg.svg" alt="Spark Scooter SVG">
            </a>
        </h1>

        <nav>
                <div class="navlink-box">
                    <a href="invoices.html">
                        <img class="invoice-spark" src="img/invoice.svg" alt="Spark Scooter SVG">
                    </a>
                </div>
        </nav>
    </header>  
    <div class="table-wrapper">
        <table>
            <h1 class="table-header">Invoices</h1>
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Issued</th>
                    <th>Due Date</th>
                    <th>Amount (SEK)</th>
                    <th>Paid</th>
                    <th>Relates to</th>
                </tr>
            </thead>
            <tbody id="invoice-table-body">
            </tbody>
        </table>
    </div>

    <script>
        async function loadInvoices() {
            try {
                const res = await fetch('/api/invoices');
                const invoices = await res.json();

                const tbody = document.getElementById('invoice-table-body');
                tbody.innerHTML = '';

                invoices.forEach(inv => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${inv.id}</td>
                        <td>${inv.issued_date}</td>
                        <td>${inv.due_date}</td>
                        <td>${inv.amount}</td>
                        <td class="pay-cell">
                            ${inv.paid 
                                ? '<span class="checkmark">Paid</span>' 
                                : `<a href="pay.html?id=${inv.id}" class="pay-button">Pay</a>`
                            }
                        </td>
                        <td><a href="#${inv.rental_id}">${inv.rental_id}</a></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("Failed to load invoices:", err);
            }
        }

        loadInvoices();

        document.querySelectorAll('.title-spark, .invoice-spark').forEach(el => {
          el.addEventListener('animationend', () => {
            el.style.pointerEvents = 'auto';
          });
        });
    
        const html = document.documentElement;
        const toggle = document.getElementById("theme-toggle");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        let savedTheme = localStorage.getItem("theme");
    
        if (!savedTheme) {
          savedTheme = prefersDark ? "dark" : "light";
        }
        html.classList.add(savedTheme + "-mode");
    
        toggle.addEventListener("click", () => {
          const current = html.classList.contains("dark-mode") ? "dark" : "light";
          const newTheme = current === "dark" ? "light" : "dark";
          html.classList.remove(current + "-mode");
          html.classList.add(newTheme + "-mode");
          localStorage.setItem("theme", newTheme);
        });
    </script>
</body>
</html>